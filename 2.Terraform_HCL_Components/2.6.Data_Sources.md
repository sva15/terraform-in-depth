# Chapter 2.6: Data Sources 

## What This Chapter is About

This chapter explains **data sources** - Terraform's way of looking up existing information. While resources create new infrastructure, data sources find and use information that already exists.

## Key Concept: Data Sources = Information Lookups

Think of data sources as "search queries" for infrastructure:
- **Resources** = CREATE new things
- **Data Sources** = FIND existing things

It's like the difference between:
- Building a new house (resource)
- Looking up an address in a phone book (data source)

## Data Source Structure

Data sources look almost identical to resources:

```t
data "data_source_type" "your_name" {
  # Search criteria go here
}
```

### Comparing Resource vs Data Source:
```t
# Resource - CREATES a new VPC
resource "aws_vpc" "new" {
  cidr_block = "10.0.0.0/16"
}

# Data Source - FINDS an existing VPC
data "aws_vpc" "existing" {
  default = true
}
```

## Real Example: Finding Network Information

The chapter shows finding a VPC and its subnets:

### Step 1: Find the Default VPC
```t
data "aws_vpc" "default" {
  default = true  # Look for the default VPC
}
```

This searches for the VPC that AWS automatically creates in each region.

### Step 2: Find Subnets in that VPC
```t
data "aws_subnets" "default" {
  filter {
    name   = "vpc-id"
    values = [data.aws_vpc.default.id]  # Use the VPC we found
  }
}
```

This finds all subnets belonging to the VPC we found in Step 1.

## Complex Filtering Example

Some data sources need more specific filtering:

```t
data "aws_ami" "ubuntu" {
  most_recent = true                    # Get the newest one
  owners      = ["099720109477"]       # Ubuntu's AWS account
  
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
  }
  
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}
```

This finds:
- The most recent Ubuntu 20.04 AMI
- Published by the official Ubuntu account
- That uses HVM virtualization

## How Data Sources Work

### 1. You Define Search Criteria
```t
data "aws_instance" "web_server" {
  instance_tags = {
    Name = "Production Web Server"
  }
}
```

### 2. Terraform Searches
When you run `terraform plan`, it:
- Connects to AWS
- Searches for instances with tag "Name = Production Web Server"
- Returns the matching instance

### 3. You Use the Results
```t
output "web_server_ip" {
  value = data.aws_instance.web_server.public_ip
}
```

## Common Use Cases

### 1. Finding Latest Images/AMIs
```t
# Always use the latest Amazon Linux
data "aws_ami" "amazon_linux" {
  most_recent = true
  owners      = ["amazon"]
  
  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*"]
  }
}

resource "aws_instance" "web" {
  ami = data.aws_ami.amazon_linux.id  # Use the AMI we found
  # ...
}
```

### 2. Working with Existing Networks
```t
# Find existing VPC by tag
data "aws_vpc" "production" {
  tags = {
    Environment = "production"
  }
}

# Create new subnet in that VPC
resource "aws_subnet" "new" {
  vpc_id     = data.aws_vpc.production.id
  cidr_block = "10.0.50.0/24"
}
```

### 3. Looking Up Secrets
```t
# Find database password from AWS Secrets Manager
data "aws_secretsmanager_secret" "db_password" {
  name = "prod/database/password"
}

data "aws_secretsmanager_secret_version" "db_password" {
  secret_id = data.aws_secretsmanager_secret.db_password.id
}
```

## Handling Missing Data

What happens when a data source finds nothing?

### Most Data Sources: Error
```t
data "aws_instance" "missing" {
  instance_id = "i-doesnotexist"  # This will cause an error!
}
```

### Some Data Sources: Empty Results
```t
data "aws_instances" "none" {
  instance_tags = {
    Name = "DoesNotExist"
  }
}
# Returns empty list instead of error
```

**Rule of thumb:**
- Single item lookups → Error if not found
- Multiple item lookups → Empty list if none found

## Data Sources vs Resources

| Aspect | Resource | Data Source |
|--------|----------|-------------|
| Purpose | Create/modify infrastructure | Look up existing infrastructure |
| Keyword | `resource` | `data` |
| Can modify? | Yes | No (read-only) |
| Example | `resource "aws_instance" "new"` | `data "aws_ami" "ubuntu"` |
| When runs | During `terraform apply` | During `terraform plan` |

## Best Practices

### 1. Use Data Sources for External Dependencies
```t
# Good: Look up VPC managed elsewhere
data "aws_vpc" "shared" {
  tags = {
    Name = "shared-services-vpc"
  }
}
```

### 2. Keep Filters Specific
```t
# Too broad - might match multiple
data "aws_vpc" "bad" {
  tags = {
    Environment = "prod"  # Many VPCs might have this
  }
}

# Better - more specific
data "aws_vpc" "good" {
  tags = {
    Name        = "main-prod-vpc"
    Environment = "prod"
  }
}
```

### 3. Use most_recent for Images
```t
data "aws_ami" "web" {
  most_recent = true  # Always get security updates
  # ... filters ...
}
```

## Complete Example: Web Server with Existing Infrastructure

```t
# Find existing VPC
data "aws_vpc" "main" {
  tags = {
    Name = "production-vpc"
  }
}

# Find subnet in that VPC
data "aws_subnet" "web" {
  vpc_id = data.aws_vpc.main.id
  
  tags = {
    Tier = "public"
  }
}

# Find latest Ubuntu AMI
data "aws_ami" "ubuntu" {
  most_recent = true
  owners      = ["099720109477"]
  
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"]
  }
}

# Create instance using all the data we found
resource "aws_instance" "web" {
  ami           = data.aws_ami.ubuntu.id
  instance_type = "t3.micro"
  subnet_id     = data.aws_subnet.web.id
  
  tags = {
    Name = "web-server"
  }
}
```

## Key Takeaways

1. **Data sources are read-only** - They find things, they don't create things
2. **Use them to connect to existing infrastructure** - VPCs, subnets, images, etc.
3. **They run during planning** - Information is gathered before any changes
4. **Filtering is important** - Be specific to avoid ambiguity
5. **They make code flexible** - No hardcoding IDs or values

Data sources are essential for making your Terraform code work with existing infrastructure and keeping it maintainable over time.
