# Chapter 3.4: Outputs

## What This Chapter is About

This chapter explains **outputs** - how modules share information with the outside world. Outputs are the return values of modules, allowing other parts of your infrastructure to use data created inside the module.

## Key Concept: Outputs = Module Return Values

Think of outputs like:
- **Function return values**: What a function gives back after processing
- **API responses**: Data an API sends back after a request
- **Package contents label**: What's inside the box, clearly marked on the outside

## Output Structure

### Basic Syntax
```t
output "name" {
  value = expression_or_value
}
```

### All Output Arguments
```t
output "complete_example" {
  description = "What this output provides"     # Documentation
  value       = resource.example.attribute      # The actual data
  sensitive   = true                           # Hide from logs
  depends_on  = [resource.other]               # Explicit dependencies
}
```

## Real Examples

### Basic Resource Outputs
```t
# In module/outputs.tf
output "aws_instance_arn" {
  description = "The AWS Resource Name for the instance"
  value       = aws_instance.hello_world.arn
}

output "aws_instance_ip" {
  description = "The IP Address for the private network interface"
  value       = aws_instance.hello_world.private_ip
}

output "aws_instance" {
  description = "The entire instance resource"
  value       = aws_instance.hello_world  # Can output entire resources!
}
```

### Using Module Outputs
```t
# Using the module
module "my_instance" {
  source    = "github.com/YOU_USERNAME/terraform-aws-instance"
  subnet_id = var.subnet_id
}

# Accessing outputs from the module
resource "aws_security_group_rule" "allow_access" {
  security_group_id = aws_security_group.main.id
  
  description = "Allow HTTPS from instance"
  from_port   = 443
  to_port     = 443
  ip_protocol = "tcp"
  
  # Using the module's output
  cidr_ipv4 = "${module.my_instance.aws_instance_ip}/32"
}
```

## Sensitive Outputs

### When to Use
Mark outputs as sensitive when they contain:
- Passwords
- API keys
- Private keys
- Connection strings with credentials

### Example
```t
# Generating a password
resource "random_password" "db" {
  length  = 32
  special = true
}

# Sensitive output
output "database_password" {
  description = "The password created by this module"
  value       = random_password.db.result
  sensitive   = true  # Won't display in CLI output
}

# If a sensitive value is used, output must be sensitive too
variable "api_key" {
  type      = string
  sensitive = true
}

output "connection_string" {
  value     = "https://api.example.com?key=${var.api_key}"
  sensitive = true  # Required because it contains sensitive data
}
```

**Warning**: Sensitive values are still stored in state files!

## Output Dependencies

### Explicit Dependencies
```t
# Ensure load balancer is configured before returning instance
output "load_balanced_instance" {
  description = "Instance after load balancer attachment"
  value       = aws_instance.web
  
  depends_on = [
    aws_lb_target_group_attachment.web_attachment
  ]
}

# Ensure all firewall rules are created first
output "secured_instance_ip" {
  description = "Instance IP after security rules applied"
  value       = aws_instance.app.private_ip
  
  depends_on = [
    aws_security_group_rule.ingress,
    aws_security_group_rule.egress
  ]
}
```

## Complete Module Example

```t
# === main.tf ===
resource "aws_instance" "web" {
  ami           = var.ami_id
  instance_type = var.instance_type
  subnet_id     = var.subnet_id
  
  vpc_security_group_ids = [aws_security_group.web.id]
  
  tags = {
    Name = "${var.name_prefix}-web"
  }
}

resource "aws_security_group" "web" {
  name_prefix = "${var.name_prefix}-"
  vpc_id      = var.vpc_id
}

resource "aws_security_group_rule" "http" {
  type              = "ingress"
  from_port         = 80
  to_port           = 80
  protocol          = "tcp"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.web.id
}

resource "aws_eip" "web" {
  count    = var.assign_public_ip ? 1 : 0
  instance = aws_instance.web.id
}

# === outputs.tf ===

# Basic information
output "instance_id" {
  description = "ID of the EC2 instance"
  value       = aws_instance.web.id
}

output "instance_arn" {
  description = "ARN of the EC2 instance"
  value       = aws_instance.web.arn
}

# Network information
output "private_ip" {
  description = "Private IP address of the instance"
  value       = aws_instance.web.private_ip
}

output "public_ip" {
  description = "Public IP address of the instance (if assigned)"
  value       = var.assign_public_ip ? aws_eip.web[0].public_ip : null
}

# Security group for additional rules
output "security_group_id" {
  description = "ID of the security group attached to the instance"
  value       = aws_security_group.web.id
}

# Complete instance object for advanced use
output "instance" {
  description = "The complete aws_instance resource"
  value       = aws_instance.web
}

# Connection information
output "ssh_connection_string" {
  description = "SSH connection command"
  value       = var.assign_public_ip ? "ssh ec2-user@${aws_eip.web[0].public_ip}" : null
}

# Example with depends_on
output "instance_ready" {
  description = "Instance ID after all configuration is complete"
  value       = aws_instance.web.id
  
  depends_on = [
    aws_security_group_rule.http,
    aws_eip.web
  ]
}
```

## Common Patterns

### 1. VPC Module Outputs
```t
# VPC module outputs what other modules need
output "vpc_id" {
  description = "ID of the VPC"
  value       = aws_vpc.main.id
}

output "public_subnet_ids" {
  description = "List of public subnet IDs"
  value       = aws_subnet.public[*].id
}

output "private_subnet_ids" {
  description = "List of private subnet IDs"
  value       = aws_subnet.private[*].id
}

# Used by other modules
module "vpc" {
  source = "./modules/vpc"
}

module "app" {
  source = "./modules/app"
  
  vpc_id    = module.vpc.vpc_id
  subnet_id = module.vpc.private_subnet_ids[0]
}
```

### 2. Database Module Outputs
```t
# Database module outputs
output "endpoint" {
  description = "Database connection endpoint"
  value       = aws_db_instance.main.endpoint
}

output "port" {
  description = "Database port"
  value       = aws_db_instance.main.port
}

output "database_name" {
  description = "Name of the database"
  value       = aws_db_instance.main.db_name
}

output "connection_string" {
  description = "Full connection string (without password)"
  value       = "postgresql://${aws_db_instance.main.username}@${aws_db_instance.main.endpoint}:${aws_db_instance.main.port}/${aws_db_instance.main.db_name}"
}
```

### 3. Computed Outputs
```t
# Outputs can include calculations
output "estimated_monthly_cost" {
  description = "Estimated monthly cost in USD"
  value       = (
    var.instance_count * 
    local.hourly_instance_cost * 
    24 * 30
  )
}

output "resource_summary" {
  description = "Summary of created resources"
  value = {
    instances = length(aws_instance.app)
    buckets   = length(aws_s3_bucket.data)
    total     = length(aws_instance.app) + length(aws_s3_bucket.data)
  }
}
```

## Best Practices

### 1. Provide Useful Descriptions
```t
# ❌ Bad - no description
output "id" {
  value = aws_instance.web.id
}

# ✅ Good - clear description
output "instance_id" {
  description = "The unique identifier of the EC2 instance"
  value       = aws_instance.web.id
}
```

### 2. Output What Users Need
```t
# ✅ Good - outputs commonly needed values
output "load_balancer_dns" {
  description = "DNS name of the load balancer"
  value       = aws_lb.main.dns_name
}

output "load_balancer_zone_id" {
  description = "Zone ID of the load balancer (for Route53)"
  value       = aws_lb.main.zone_id
}
```

### 3. Group Related Outputs
```t
# Option 1: Separate outputs
output "db_endpoint" {
  value = aws_db_instance.main.endpoint
}

output "db_port" {
  value = aws_db_instance.main.port
}

output "db_name" {
  value = aws_db_instance.main.db_name
}

# Option 2: Grouped output
output "database_config" {
  description = "Database connection information"
  value = {
    endpoint = aws_db_instance.main.endpoint
    port     = aws_db_instance.main.port
    name     = aws_db_instance.main.db_name
  }
}
```

### 4. Handle Optional Resources
```t
# When resources might not exist
output "public_ip" {
  description = "Public IP if assigned"
  value       = length(aws_eip.public) > 0 ? aws_eip.public[0].public_ip : null
}

# Or use try()
output "nat_gateway_ip" {
  description = "NAT Gateway IP if created"
  value       = try(aws_nat_gateway.main[0].public_ip, null)
}
```

## Key Takeaways

1. **Outputs are module return values** - They expose internal data to module users
2. **Essential for module composition** - Link modules together by passing outputs as inputs
3. **Always include descriptions** - Help users understand what each output provides
4. **Mark sensitive data** - Prevent passwords and secrets from being displayed
5. **Output what's needed** - Think about what users of your module will need
6. **State storage warning** - Sensitive outputs are still saved in state files

Outputs are the bridge between modules, enabling you to build complex infrastructure by connecting simple, reusable components.
